@model IEnumerable<SistemaBliss.EN.Cita>

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<form method="get" action="@Url.Action("Index", "Cita")" class="row">

    <h3 class="titulo">Citas</h3>
    <p class="parrafo">Busca una cita en los siguientes filtros de fecha</p>

    <div class="col-12 col-lg-3 mt-2">
        <label class="form-label fw-bold" for="FechaInicioPendientes">Fecha de inicio:</label>
        <input type="date" class="form-control" name="FechaInicioPendientes" placeholder="Seleccione la fecha de inicio" />
    </div>

    <div class="col-12 col-lg-3 mt-2">
        <label class="form-label fw-bold" for="FechaFinPendientes">Fecha de fin:</label>
        <input type="date" class="form-control" name="FechaFinPendientes" placeholder="Seleccione la fecha de fin" />
    </div>


    <div class="col-12 col-lg-2 d-flex gap-3 align-items-end mt-2">
        <button type="submit" class="btn btn-second mx-2">Buscar</button>
        @Html.ActionLink("Nuevo", "Create", null, new { @Class = "btn-morado" })
    </div>


</form>


<ul class="nav d-flex nav-pills mt-4 mb-3" id="pills-tab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#pills-home" type="button" role="tab" aria-controls="pills-home" aria-selected="true">Confirmadas</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile" type="button" role="tab" aria-controls="pills-profile" aria-selected="false">Pendientes</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="pills-contact-tab" data-bs-toggle="pill" data-bs-target="#pills-contact" type="button" role="tab" aria-controls="pills-contact" aria-selected="false">Finalizadas</button>
    </li>
</ul>
<div class="tab-content" id="pills-tabContent">
    <div class="tab-pane fade show active" id="pills-home" role="tabpanel" aria-labelledby="pills-home-tab" tabindex="0">
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Tiempo</th>
                    <th>Pago</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @if (ViewBag.CitasConfirmadas != null)
                {
                    foreach (var item in ViewBag.CitasConfirmadas)
                    {
                        <tr>
                            <td>@item.IdCita</td>
                            <td>@item.Cliente</td>
                            <td>@item.Fecha.ToString("dd 'de' MMMM 'de' yyyy", new System.Globalization.CultureInfo("es-ES"))</td>
                            <td>@DateTime.Today.Add(item.Hora).ToString("hh:mm tt")</td> 
                            <td>@item.TiempoTotal.ToString(@"hh\:mm")</td>
                            <td class="d-flex"> <p>$</p> @item.PagoTotal</td>
                            <td>
                                <a href="@Url.Action("Edit", "Cita", new { id = item.IdCita })" class="btn btn-editar btn-sm mx-2">Administrar</a>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
    <div class="tab-pane fade" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab" tabindex="0">
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Tiempo</th>
                    <th>Pago</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @if (ViewBag.CitasPendientes != null)
                {
                    foreach (var item in ViewBag.CitasPendientes)
                    {
                        <tr>
                            <td>@item.IdCita</td>
                            <td>@item.Cliente</td>
                            <td>@item.Fecha.ToString("dd 'de' MMMM 'de' yyyy", new System.Globalization.CultureInfo("es-ES"))</td>
                            <td>@DateTime.Today.Add(item.Hora).ToString("hh:mm tt")</td> <!-- Hora con AM/PM -->
                            <td>@item.TiempoTotal.ToString(@"hh\:mm")</td> <!-- Formato de tiempo total -->
                            <td class="d-flex"> <p>$</p> @item.PagoTotal</td>
                            <td>
                                <a href="@Url.Action("Edit", "Cita", new { id = item.IdCita })" class="btn btn-editar btn-sm mx-2">Administrar</a>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
    <div class="tab-pane fade" id="pills-contact" role="tabpanel" aria-labelledby="pills-contact-tab" tabindex="0">
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Tiempo</th>
                    <th>Pago</th>
                </tr>
            </thead>
            <tbody>
                @if (ViewBag.CitasFinalizadas != null)
                {
                    foreach (var item in ViewBag.CitasFinalizadas)
                    {
                        <tr>
                            <td>@item.IdCita</td>
                            <td>@item.Cliente</td>
                            <td>@item.Fecha.ToString("dd 'de' MMMM 'de' yyyy", new System.Globalization.CultureInfo("es-ES"))</td>
                            <td>@DateTime.Today.Add(item.Hora).ToString("hh:mm tt")</td> <!-- Hora con AM/PM -->
                            <td>@item.TiempoTotal.ToString(@"hh\:mm")</td> <!-- Formato de tiempo total -->
                            <td class="d-flex"> <p>$</p> @item.PagoTotal</td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

@section scripts {

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tabs = document.querySelectorAll('#pills-tab button');
            tabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    localStorage.setItem('selectedTab', this.getAttribute('id'));
                });
            });

            const selectedTab = localStorage.getItem('selectedTab');
            if (selectedTab) {
                const tabToActivate = document.querySelector(`#${selectedTab}`);
                if (tabToActivate) {
                    tabToActivate.click();
                }
            } else {
                // Activar por defecto el tab de Empleados Activos
                const defaultTab = document.querySelector('#pills-activos-tab');
                if (defaultTab) {
                    defaultTab.click();
                }
            }
        });

    </script>

    @if (TempData["mensaje"] != null)
    {
        <script>
     Swal.fire({
         icon: "@(TempData["tipo"]!= null? TempData["tipo"]: "success")",
         title: "@TempData["mensaje"]",
         showConfirmButton: false,
         timer: 1500
     });
        </script>

        TempData["mensaje"] = null; // Vaciar memoria
    }

}